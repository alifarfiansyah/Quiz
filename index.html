<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Quiz App</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
  body {
    padding-top: 20px;
    background: #f8fafc;
    font-family: "Inter", system-ui, sans-serif;
  }

  h3 {
    font-weight: 700;
    color: #0d6efd;
  }

  .card-custom {
    border-radius: 1rem;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    background: #fff;
    padding: 20px;
  }

  .nav-qbtn {
    margin: 4px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    font-weight: 600;
    transition: 0.2s;
  }

  .nav-qbtn:hover {
    transform: scale(1.05);
  }

  .nav-qbtn.answered {
    background: #198754;
    color: #fff;
  }

  .nav-qbtn.unanswered {
    background: #dc3545;
    color: #fff;
  }

  .question-card {
    padding: 20px;
    border-radius: 1rem;
    border: 1px solid #e5e7eb;
    background: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.04);
  }

  .timer {
    font-weight: 700;
    font-size: 1.2rem;
    color: #dc3545;
  }
</style>
</head>

<body class="container">
  <h3 class="mb-3">Quiz App</h3>

  <!-- Login -->
  <div id="loginSection" class="mb-3">
    <div class="form-group mb-2">
      <input id="studentName" class="form-control" placeholder="Your name">
    </div>

    <div class="form-group mb-2">
      <input id="quizCodeInput" class="form-control" placeholder="Enter quiz code (e.g., MATH01)">
    </div>

    <div class="d-flex gap-2">
      <button id="startBtn" class="btn btn-primary">Start Quiz</button>
      <button id="debugBtn" class="btn btn-outline-secondary">Debug: Load Data</button>
    </div>

    <div id="loginMsg" class="text-danger mt-2"></div>
  </div>

  <!-- Quiz -->
  <div id="quizSection" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div><strong id="quizTitle">Quiz</strong></div>
      <div class="timer text-danger" id="timerDisplay">00:00</div>
    </div>

    <div id="questionNav" class="mb-2"></div>
    <div id="questionWrapper" class="question-card mb-3"></div>

    <div class="d-flex justify-content-between">
      <button id="prevBtn" class="btn btn-secondary">Prev</button>
      <button id="nextBtn" class="btn btn-secondary">Next</button>
    </div>

    <div class="mt-3">
      <button id="submitBtn" class="btn btn-success">Submit</button>
    </div>

    <div id="statusMsg" class="mt-2"></div>
      </div>


<script>
/* ---------------- CONFIG ---------------- */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyocX7BFI0v_YTcP3mgedCHQKinP8ZMGLfcyN1rTZC3_ja4cPEftvqLris76DMjqsiVfA/exec";

/* ---------------- STATE ---------------- */
let rawData = null,
    quizSetting = null,
    quizQuestions = [],
    currentIndex = 0,
    timerInterval = null,
    timeLeft = 0;

/* ---------------- HELPERS ---------------- */
const $ = id => document.getElementById(id);

const fmtTime = s => {
  s = Math.max(0, s|0);
  const m = (s/60|0),
        sec = s % 60;
  return `${m}:${sec < 10 ? "0"+sec : sec}`;
};

const shuffle = arr => arr
  .map(v => [Math.random(), v])
  .sort((a, b) => a[0]-b[0])
  .map(x => x[1]);

async function fetchQuizData() {
  const res = await fetch(SCRIPT_URL + "?action=getQuizData", { cache:"no-store" });
  if (!res.ok) throw new Error("Fetch failed: " + res.status);
  return await res.json();
}

function optionKeys(q) {
  return Object.keys(q)
    .filter(k => /^Option\d+$/i.test(k) && q[k])
    .sort((a, b) => parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,'')));
}

/* ---------------- SELECTION ---------------- */
function selectWithQuotas(pool, setting) {
  const quotas = {
    Hard:   +setting.Hard   || 0,
    Medium: +setting.Medium || 0,
    Easy:   +setting.Easy   || 0
  };

  const byDiff = {
    Hard:   shuffle(pool.filter(q => (q.Difficulty||"").toLowerCase()==="hard")),
    Medium: shuffle(pool.filter(q => (q.Difficulty||"").toLowerCase()==="medium")),
    Easy:   shuffle(pool.filter(q => (q.Difficulty||"").toLowerCase()==="easy"))
  };

  const pickExact = (arr, n) => arr.splice(0, Math.min(n, arr.length));

  const selected = [];
  const gotHard = pickExact(byDiff.Hard, quotas.Hard);   selected.push(...gotHard);
  const gotMed  = pickExact(byDiff.Medium, quotas.Medium); selected.push(...gotMed);
  const gotEasy = pickExact(byDiff.Easy, quotas.Easy);   selected.push(...gotEasy);

  let shortHard = quotas.Hard   - gotHard.length,
      shortMed  = quotas.Medium - gotMed.length,
      shortEasy = quotas.Easy   - gotEasy.length;

  if (shortHard > 0) {
    const fillM = pickExact(byDiff.Medium, shortHard);
    selected.push(...fillM);
    shortHard -= fillM.length;

    if (shortHard > 0) {
      const fillE = pickExact(byDiff.Easy, shortHard);
      selected.push(...fillE);
    }
  }

  if (shortMed > 0) {
    const fillE = pickExact(byDiff.Easy, shortMed);
    selected.push(...fillE);
  }

  const selectedSet = new Set(selected.map(o => o.QuestionID));
  const remain = pool.filter(q => !selectedSet.has(q.QuestionID));

  const remainingNeeded = 
    (shortHard>0 ? shortHard : 0) +
    (shortMed>0  ? shortMed  : 0) +
    (shortEasy>0 ? shortEasy : 0);

  if (remainingNeeded > 0 && remain.length > 0) {
    selected.push(...shuffle(remain).slice(0, remainingNeeded));
  }

  return shuffle(selected);
}

/* ---------------- RENDERING ---------------- */
function buildNav() {
  const nav = $("questionNav");
  nav.innerHTML = "";

  quizQuestions.forEach((q, i) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "btn nav-qbtn " + (q.selected ? "answered":"unanswered");
    btn.textContent = i+1;
    btn.onclick = () => { currentIndex=i; renderQuestion(); };
    nav.appendChild(btn);
  });
}

function updateNavStyles() {
  Array.from($("questionNav").children).forEach((btn, i) => {
    btn.classList.toggle("answered", !!quizQuestions[i].selected);
    btn.classList.toggle("unanswered", !quizQuestions[i].selected);
  });
}

function renderQuestion() {
  const q = quizQuestions[currentIndex],
        wrap = $("questionWrapper");

  if (!q) {
    wrap.innerHTML = "<div>No question</div>";
    return;
  }

  let html = `
    <div><strong>Q${currentIndex+1}</strong>
    [${q.Subject||''}, ${q.Difficulty||''}, Grade ${q.Grade||''}]</div>
    <hr/>
    <div class="mb-2">${q.Question||""}</div>
  `;

  const opts = optionKeys(q);

  if (opts.length === 0) {
    html += `<div class="text-muted">No options provided.</div>`;
  } else {
    html += `<div>`;
    opts.forEach((key, idx) => {
      const idx1 = idx+1;
      const checked = String(q.selected||"") === String(idx1) ? "checked" : "";
      html += `
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
            name="answer" id="opt${idx}" value="${idx1}" ${checked}>
          <label class="form-check-label" for="opt${idx}">
            ${q[key]}
          </label>
        </div>`;
    });
    html += `</div>`;
  }

  wrap.innerHTML = html;

  if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();

  document.querySelectorAll('input[name="answer"]').forEach(inp => {
    inp.addEventListener("change", ev => {
      q.selected = ev.target.value;
      updateNavStyles();
    });
  });

  updateNavStyles();
}

function updateTimer() {
  $("timerDisplay").textContent = fmtTime(timeLeft);
}

/* ---------------- EVENTS ---------------- */
$("debugBtn").addEventListener("click", async () => {
  try {
    rawData = await fetchQuizData();
    console.log("DEBUG settings:", rawData.settings);
    console.log("DEBUG questions:", rawData.questions);
    $("loginMsg").textContent = "Loaded. Open console to inspect.";
  } catch(e) {
    console.error(e);
    $("loginMsg").textContent = e.message;
  }
});

$("startBtn").addEventListener("click", async () => {
  const name = $("studentName").value.trim();
  const code = $("quizCodeInput").value.trim().toUpperCase();

  if (!name) { $("loginMsg").textContent="Enter name."; return; }
  if (!code) { $("loginMsg").textContent="Enter quiz code."; return; }

  try {
    rawData = await fetchQuizData();
  } catch(e) {
    $("loginMsg").textContent="Cannot load quiz data: "+e.message;
    return;
  }

  quizSetting = (rawData.settings||[])
    .find(s => String(s.Code||"").toUpperCase().trim() === code);

  if (!quizSetting) {
    $("loginMsg").textContent="Quiz code not found.";
    return;
  }

  const now = new Date(),
        start = quizSetting.StartDate ? new Date(quizSetting.StartDate) : null,
        end   = quizSetting.EndDate   ? new Date(quizSetting.EndDate)   : null;

  if (start && now < start) {
    $("loginMsg").textContent="Quiz not started.";
    return;
  }

  if (end && now > end) {
    $("loginMsg").textContent="Quiz expired.";
    return;
  }

  const pool = (rawData.questions||[]).filter(q =>
    String(q.QuizCode||"").toUpperCase().trim() === code &&
    String(q.Subject||"").toUpperCase().trim() === String(quizSetting.Subject||"").toUpperCase().trim() &&
    String(q.Grade||"") === String(quizSetting.Grade||"")
  );

  if (pool.length===0) {
    $("loginMsg").textContent="No questions match.";
    return;
  }

  quizQuestions = selectWithQuotas(pool, quizSetting);

  if (quizQuestions.length===0) {
    $("loginMsg").textContent="Selection produced no questions.";
    return;
  }

  $("loginSection").style.display="none";
  $("quizSection").style.display="block";
  $("quizTitle").textContent = `${quizSetting.Title||"Quiz"} (${quizSetting.Subject||""})`;

  currentIndex = 0;
  buildNav();
  renderQuestion();

  const limitSec = (+quizSetting.TimeLimit||0) * 60;
  const untilEnd = end ? Math.max(0, ((end-now)/1000)|0) : Infinity;
  timeLeft = Math.min(limitSec||Infinity, untilEnd||Infinity);

  if (!isFinite(timeLeft) || timeLeft<=0)
    timeLeft = limitSec > 0 ? limitSec : 600;

  updateTimer();
  if (timerInterval) clearInterval(timerInterval);

  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimer();
    if (timeLeft<=0) {
      clearInterval(timerInterval);
      alert("Time is up — auto-submitting.");
      submitQuiz(true);
    }
  }, 1000);
});

$("prevBtn").addEventListener("click", () => {
  if (currentIndex>0) {
    currentIndex--;
    renderQuestion();
  }
});

$("nextBtn").addEventListener("click", () => {
  if (currentIndex<quizQuestions.length-1) {
    currentIndex++;
    renderQuestion();
  }
});

$("submitBtn").addEventListener("click", e => {
  e.preventDefault();
  submitQuiz(false);
});

/* ---------------- SUBMIT ---------------- */
function submitQuiz(auto=false) {
  if (!auto && !confirm("Submit quiz?")) return;

  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }

  const answers = {};
  const correct = quizQuestions.reduce((acc, q) => {
    const key = q.QuestionID || ("Q_"+Math.random().toString(36).slice(2,8));
    answers[key] = q.selected ? String(q.selected) : null;
    const expected = q.Answer == null ? null : String(q.Answer);
    if (answers[key] && expected && answers[key]===expected) return acc+1;
    return acc;
  }, 0);

  const score = quizQuestions.length 
    ? Math.round(100*correct/quizQuestions.length) : 0;
  const pass = score >= (+quizSetting.MinScore||0) ? "PASS" : "FAIL";

  const payload = {
    studentName: $("studentName").value,
    quizCode: quizSetting.Code,
    subject: quizSetting.Subject,
    answers, score, pass
  };

  sendResult(payload)
    .then(() => {
      alert(`Score: ${score}%, ${pass}`);
      window.location.reload();
    })
    .catch(() => {
      // alert("Submit failed — see console");
    });
}

function sendResult(payload) {
  return fetch(SCRIPT_URL, {
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    })
    .then(res => res.text())
    .then(txt => {
      const data = JSON.parse(txt);
      if (data && data.status==="success") {
        console.log("✅ Submit success:", data);
      } else {
        console.error("❌ Submit error:", data);
        throw new Error("Server error");
      }
    })
    .catch(err => {
      console.error("⚠️ Network error:", err);
      // alert("Submit failed (network). See console.");
    });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
