<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Quiz App</title>

  <!-- Bootstrap & MathJax -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    body { padding-top: 18px; background: #f8f9fa; }
    .nav-qbtn { margin: 2px; width: 40px; }
    .nav-qbtn.answered { background:#28a745; color:#fff; }
    .nav-qbtn.unanswered { background:#dc3545; color:#fff; }
    .question-card { padding:16px; border-radius:10px; border:1px solid #ddd; background:#fff; }
    .timer { font-weight:700; font-size:1.1rem; }
  </style>
</head>

<body class="container">
  <h2 class="mb-4 text-primary fw-bold">üìò Quiz App</h2>

  <!-- Login -->
  <section id="loginSection" class="mb-3">
    <div class="form-group mb-2">
      <input id="studentName" class="form-control" placeholder="Your name">
    </div>
    <div class="form-group mb-2">
      <input id="quizCodeInput" class="form-control" placeholder="Enter quiz code (e.g., MATH01)">
    </div>
    <div class="d-flex gap-2">
      <button id="startBtn" class="btn btn-primary">Start Quiz</button>
      <button id="debugBtn" class="btn btn-outline-secondary">Debug: Load Data</button>
    </div>
    <div id="loginMsg" class="text-danger mt-2"></div>
  </section>

  <!-- Quiz -->
  <section id="quizSection" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 id="quizTitle" class="mb-0 text-success"></h4>
      <div id="timerDisplay" class="timer text-danger">00:00</div>
    </div>

    <div id="questionNav" class="mb-3"></div>
    <div id="questionWrapper" class="question-card mb-3"></div>

    <div class="d-flex justify-content-between">
      <button id="prevBtn" class="btn btn-outline-primary">‚Üê Prev</button>
      <button id="nextBtn" class="btn btn-outline-primary">Next ‚Üí</button>
    </div>

    <div class="mt-4 text-center">
      <button id="submitBtn" class="btn btn-lg btn-success">‚úÖ Submit Quiz</button>
    </div>
    <div id="statusMsg" class="mt-2"></div>
  </section>

<script>
/* ---------------- CONFIG ---------------- */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyocX7BFI0v_YTcP3mgedCHQKinP8ZMGLfcyN1rTZC3_ja4cPEftvqLris76DMjqsiVfA/exec";

/* ---------------- STATE ---------------- */
let rawData = null;
let quizSetting = null;
let quizQuestions = [];
let currentIndex = 0;
let timerInterval = null;
let timeLeft = 0;

/* ---------------- HELPERS ---------------- */
const $ = id => document.getElementById(id);
const fmtTime = s => {
  s = Math.max(0, s|0);
  const m = (s/60|0), sec = s%60;
  return `${m}:${sec < 10 ? "0"+sec : sec}`;
};
const shuffle = arr => arr.map(v=>[Math.random(),v])
                          .sort((a,b)=>a[0]-b[0])
                          .map(x=>x[1]);

const optionKeys = q => Object.keys(q)
  .filter(k => /^Option\d+$/i.test(k) && q[k])
  .sort((a,b)=>parseInt(a.replace(/\D/g,''))-parseInt(b.replace(/\D/g,'')));

/* ---------------- DATA FETCH ---------------- */
async function fetchQuizData() {
  const res = await fetch(SCRIPT_URL+"?action=getQuizData",{cache:"no-store"});
  if (!res.ok) throw new Error("Fetch failed: "+res.status);
  return res.json();
}

/* ---------------- QUIZ FLOW ---------------- */
function buildNav() {
  const nav = $("questionNav");
  nav.innerHTML = "";
  quizQuestions.forEach((q,i) => {
    const btn = document.createElement("button");
    btn.type="button";
    btn.className="btn nav-qbtn " + (q.selected ? "answered":"unanswered");
    btn.textContent = i+1;
    btn.onclick = () => { currentIndex = i; renderQuestion(); };
    nav.appendChild(btn);
  });
}
function updateNavStyles() {
  [...$("questionNav").children].forEach((btn,i) => {
    btn.classList.toggle("answered",!!quizQuestions[i].selected);
    btn.classList.toggle("unanswered",!quizQuestions[i].selected);
  });
}
function renderQuestion() {
  const q = quizQuestions[currentIndex];
  const wrap = $("questionWrapper");
  if (!q) return wrap.innerHTML="<div>No question</div>";

  let html = `
    <div><strong>Q${currentIndex+1}</strong> 
      [${q.Subject||""}, ${q.Difficulty||""}, Grade ${q.Grade||""}]</div>
    <hr/>
    <div class="mb-2">${q.Question||""}</div>
  `;
  const opts = optionKeys(q);
  if (opts.length) {
    html += opts.map((key,idx)=>{
      const checked = String(q.selected||"")===String(idx+1) ? "checked":"";
      return `
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="answer" id="opt${idx}" value="${idx+1}" ${checked}>
          <label class="form-check-label" for="opt${idx}">${q[key]}</label>
        </div>`;
    }).join("");
  } else {
    html += `<div class="text-muted">No options provided.</div>`;
  }
  wrap.innerHTML = html;

  if (window.MathJax) MathJax.typesetPromise();
  document.querySelectorAll('input[name="answer"]').forEach(inp=>{
    inp.addEventListener("change",ev=>{
      q.selected = ev.target.value;
      updateNavStyles();
    });
  });
  updateNavStyles();
}
function updateTimer() { $("timerDisplay").textContent = fmtTime(timeLeft); }

/* ---------------- SUBMIT ---------------- */
function submitQuiz(auto=false) {
  if (!auto && !confirm("Submit quiz?")) return;
  if (timerInterval) clearInterval(timerInterval);

  const answers={}, correct = quizQuestions.reduce((acc,q)=>{
    const key = q.QuestionID || "Q_"+Math.random().toString(36).slice(2,8);
    answers[key] = q.selected ? String(q.selected):null;
    return (answers[key] && q.Answer && answers[key]===String(q.Answer)) ? acc+1 : acc;
  },0);

  const score = quizQuestions.length ? Math.round(100*correct/quizQuestions.length):0;
  const pass = score >= (+quizSetting.MinScore||0) ? "PASS" : "FAIL";
  const payload = {
    studentName:$("studentName").value,
    quizCode:quizSetting.Code,
    subject:quizSetting.Subject,
    answers, score, pass
  };

  sendResult(payload)
    .then(()=>{ alert(`üéâ Score: ${score}%, ${pass}`); window.location.reload(); })
    .catch(()=>{ alert("‚ö†Ô∏è Submit failed ‚Äî see console"); });
}
function sendResult(payload) {
  return fetch(SCRIPT_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  })
  .then(r=>r.text())
  .then(txt=>{
    const data = JSON.parse(txt);
    if(data?.status==="success"){ console.log("‚úÖ Submit success",data); }
    else { throw new Error("Server error"); }
  });
}

/* ---------------- EVENT LISTENERS ---------------- */
$("debugBtn").addEventListener("click",async()=>{
  try {
    rawData = await fetchQuizData();
    console.log("DEBUG settings:",rawData.settings);
    console.log("DEBUG questions:",rawData.questions);
    $("loginMsg").textContent="Loaded. Open console to inspect.";
  } catch(e) {
    $("loginMsg").textContent = e.message;
  }
});
$("startBtn").addEventListener("click",async()=>{
  const name = $("studentName").value.trim();
  const code = $("quizCodeInput").value.trim().toUpperCase();
  if(!name) return $("loginMsg").textContent="Enter name.";
  if(!code) return $("loginMsg").textContent="Enter quiz code.";

  try { rawData = await fetchQuizData(); }
  catch(e){ return $("loginMsg").textContent="Cannot load quiz data: "+e.message; }

  quizSetting = (rawData.settings||[]).find(s=>String(s.Code||"").toUpperCase().trim()===code);
  if(!quizSetting) return $("loginMsg").textContent="Quiz code not found.";

  // date checks
  const now=new Date(), start=quizSetting.StartDate?new Date(quizSetting.StartDate):null, end=quizSetting.EndDate?new Date(quizSetting.EndDate):null;
  if(start && now<start) return $("loginMsg").textContent="Quiz not started.";
  if(end && now>end) return $("loginMsg").textContent="Quiz expired.";

  const pool = (rawData.questions||[]).filter(q=>
    String(q.QuizCode||"").toUpperCase().trim()===code &&
    String(q.Subject||"").toUpperCase().trim()===String(quizSetting.Subject||"").toUpperCase().trim() &&
    String(q.Grade||"")===String(quizSetting.Grade||"")
  );
  if(!pool.length) return $("loginMsg").textContent="No questions match.";

  quizQuestions = shuffle(pool).slice(0,quizSetting.TotalQuestions||pool.length);
  $("loginSection").style.display="none";
  $("quizSection").style.display="block";
  $("quizTitle").textContent=`${quizSetting.Title||"Quiz"} (${quizSetting.Subject||""})`;

  currentIndex=0; buildNav(); renderQuestion();

  timeLeft = ((+quizSetting.TimeLimit||0)*60) || 600;
  updateTimer();
  timerInterval = setInterval(()=>{
    timeLeft--; updateTimer();
    if(timeLeft<=0){ clearInterval(timerInterval); alert("Time is up!"); submitQuiz(true); }
  },1000);
});
$("prevBtn").addEventListener("click",()=>{ if(currentIndex>0){ currentIndex--; renderQuestion(); }});
$("nextBtn").addEventListener("click",()=>{ if(currentIndex<quizQuestions.length-1){ currentIndex++; renderQuestion(); }});
$("submitBtn").addEventListener("click",e=>{ e.preventDefault(); submitQuiz(false); });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>
</html>
