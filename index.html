<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Pelatihan Akhir Pekan</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
      :root {
        --green-500: #22c55e;
        --green-600: #16a34a;
        --green-700: #15803d;
      }

      body {
        padding-top: 20px;
        background: #f0fdf4;
        font-family: 'Inter', system-ui, sans-serif;
        margin-bottom: auto;
      }

      h4 {
        font-weight: 700;
        color: var(--green-700);
      }

      .card-custom {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 10px 25px -5px rgba(22, 163, 74, 0.1);
      }

      .form-control:focus {
        border-color: var(--green-500);
        box-shadow: 0 0 0 0.25rem rgba(34, 197, 94, 0.25);
      }

      .nav-qbtn {
        margin: 4px;
        width: 45px;
        height: 45px;
        border-radius: 12px;
        font-weight: 700;
        transition: all 0.2s;
        border: 2px solid #e5e7eb;
        background: white;
      }

      .nav-qbtn:hover {
        transform: translateY(-3px);
        border-color: var(--green-500);
        color: var(--green-600);
      }

      .nav-qbtn.answered {
        background: var(--green-500) !important;
        border-color: var(--green-600) !important;
        color: white !important;
      }

      .nav-qbtn.unanswered {
        background: #fee2e2 !important;
        border-color: #ef4444 !important;
        color: #b91c1c !important;
      }

      .btn-green {
        background-color: var(--green-500);
        color: white;
        border: none;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-green:hover,
      .btn-green:focus,
      .btn-green:active {
        background-color: var(--green-600) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(34, 197, 94, 0.4) !important;
      }

      .btn-outline-green {
        border: 2px solid var(--green-500);
        color: var(--green-600);
        font-weight: 600;
      }

      .btn-outline-green:hover,
      .btn-outline-green:focus,
      .btn-outline-green:active {
        background-color: var(--green-500) !important;
        border-color: var(--green-500) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(34, 197, 94, 0.3) !important;
      }

      .question-card {
        padding: 20px;
        border-radius: 1rem;
        border: 1px solid #e5ebe5;
        background: #fff;
        box-shadow: 0 10px 25px -5px rgba(22, 163, 74, 0.1);
      }

      .timer {
        font-weight: 700;
        font-size: 1.2rem;
        color: #dc3545;
      }
    </style>
  </head>

  <body class="container">
    <!-- Header -->
    <div class="text-center mb-5">
      <h4 class="d-flex align-items-center justify-content-center">
        <img src="https://raw.githubusercontent.com/alifarfiansyah/Quiz/refs/heads/main/ansor.png" alt="logo" width="40" class="me-2" onerror="this.style.display='none'" /> PELATIHAN AKHIR PEKAN
      </h4>
    </div>

    <!-- Login -->
    <div id="loginSection" class="card shadow-sm p-4 mb-4 mx-auto" style="max-width: 500px; border-radius: 1rem">
      <div class="mb-3">
        <label for="studentName" class="form-label fw-semibold">Nama</label>
        <input id="studentName" class="form-control form-control-lg" placeholder="Ketik nama kamu..." />
      </div>

      <div class="mb-3">
        <label for="quizCodeInput" class="form-label fw-semibold">Kode Quiz</label>
        <input id="quizCodeInput" class="form-control form-control-lg" placeholder="Contoh: A1934" />
      </div>

      <div class="d-grid gap-2 d-md-flex justify-content-md-between">
        <button id="startBtn" class="btn btn-success btn-lg shadow w-100">Mulai Quiz</button>
        <button id="debugBtn" class="btn btn-outline-secondary btn-lg shadow w-100">Muat Data Quiz</button>
      </div>

      <div id="loginMsg" class="text-danger mt-3 text-center fw-semibold"></div>
    </div>

    <!-- Quiz -->
    <div id="quizSection" style="display: none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 id="quizTitle" class="fw-bold text-success mb-0">Quiz</h5>
        <span class="timer badge bg-danger fs-6 px-3 py-2 text-light" id="timerDisplay">00:00</span>
      </div>

      <div id="questionNav" class="mb-3 d-flex flex-wrap gap-2 justify-content-center"></div>

      <div class="alert alert-danger py-2 mb-3" style="font-size: 0.85rem">⚠️ Pelanggaran: <b id="violationCount">0</b> / 3</div>

      <div id="questionWrapper" class="card shadow-sm p-4 mb-4" style="border-radius: 1rem"></div>

      <div class="d-flex justify-content-between mb-4">
        <button id="prevBtn" class="btn btn-outline-green px-4 rounded-pill shadow-sm">← Prev</button>
        <button id="nextBtn" class="btn btn-outline-green px-4 rounded-pill shadow-sm">Next →</button>
      </div>

      <div class="text-center">
        <button id="submitBtn" class="btn btn-success btn-lg px-5">Kirim Jawaban</button>
      </div>

      <div id="statusMsg" class="mt-3 text-center fw-semibold"></div>
    </div>

    <!-- Result -->
    <div id="resultSection" style="display: none">
      <div class="card shadow-sm p-4 mb-4 mx-auto text-center">
        <div class="mb-2">
          <p class="text-muted mb-3">Quiz dengan kode: <strong id="kodeQuiz">-</strong> telah selesai.</p>
        </div>

        <div class="mb-2">
          <h3 id="studentNameResult" class="fw-bold">Nama</h3>
          <p class="text-muted">Telah menyelesaikan quiz dengan hasil akhir:</p>
          <div id="passBadge" class="badge rounded-pill fs-6 px-4 py-2 mt-2">STATUS</div>
        </div>

        <hr />

        <div class="row g-3 text-center mt-2">
          <div class="col-6">
            <div class="p-2 border rounded shadow-sm bg-light">
              <small class="text-muted d-block">Benar</small>
              <strong id="correctCount" class="fs-4">0</strong><strong class="fs-4">/</strong><strong id="totalCount" class="fs-4">0</strong>
            </div>
          </div>
          <div class="col-6">
            <div class="p-2 border rounded shadow-sm bg-light">
              <small class="text-muted d-block">Nilai</small>
              <strong id="finalScore" class="fs-4">0</strong>
            </div>
          </div>
        </div>

        <button onclick="window.location.reload()" class="btn btn-success btn-lg w-100 mt-5 rounded-pill">Selesai & Keluar</button>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="text-center">
        <span class="text-muted">© <span id="year"></span> PR. GP Ansor Desa Ngepung.</span>
      </div>
    </footer>

    <script>
      /* ---------------- CONFIG ---------------- */
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyocX7BFI0v_YTcP3mgedCHQKinP8ZMGLfcyN1rTZC3_ja4cPEftvqLris76DMjqsiVfA/exec';

      /* ---------------- STATE ---------------- */
      let rawData = null,
        quizSetting = null,
        quizQuestions = [],
        currentIndex = 0,
        timerInterval = null,
        timeLeft = 0,
        setEndTime = null,
        quizEndTime = null,
        tabViolations = 0,
        isSubmitting = false,
        shuffledOptionsMap = {},
        startTime = null,
        submitTime = null;

      /* ---------------- HELPERS ---------------- */
      const $ = (id) => document.getElementById(id);

      document.getElementById('year').textContent = new Date().getFullYear();

      document.addEventListener('contextmenu', (e) => e.preventDefault());
      document.addEventListener('visibilitychange', () => {
        if (isSubmitting || quizQuestions.length === 0) return;

        if (document.visibilityState === 'hidden' && quizQuestions.length > 0) {
          tabViolations++;
          $('violationCount').innerText = tabViolations;
          saveProgres();
          if (tabViolations >= 3) {
            console.warn('Batas pelanggaran tercapai! Sistem mengirim jawaban otomatis.');
            submitQuiz(true);
            return;
          } else {
            const msg = tabViolations === 2 ? 'PERINGATAN TERAKHIR! Sekali lagi meninggalkan halaman, jawaban akan otomatis dikirim.' : `Peringatan ${tabViolations}/3: Jangan tinggalkan halaman ujian!`;
            alert(msg);
          }
        }
      });

      function saveProgres() {
        const data = {
          endTime: quizEndTime,
          currentIndex: currentIndex,
          violations: tabViolations,
          questions: quizQuestions,
          code: $('quizCodeInput').value.toUpperCase(),
          name: $('studentName').value,
        };
        localStorage.setItem('ansor_pro_save', JSON.stringify(data));
      }

      function loadProgres(currentCode) {
        const saved = localStorage.getItem('ansor_pro_save');
        if (!saved) return null;
        const data = JSON.parse(saved);
        return data.code === currentCode && Date.now() < data.endTime ? data : null;
      }

      const fmtTime = (s) => {
        s = Math.max(0, s | 0);
        const m = (s / 60) | 0,
          sec = s % 60;
        return `${m}:${sec < 10 ? '0' + sec : sec}`;
      };

      const shuffle = (arr) =>
        arr
          .map((v) => [Math.random(), v])
          .sort((a, b) => a[0] - b[0])
          .map((x) => x[1]);

      const shuffleArray = (arr) => arr.sort(() => Math.random() - 0.5);

      const SALT = 'ANSOR1934';

      async function fetchQuizData() {
        const res = await fetch(SCRIPT_URL + '?action=getQuizData', {
          cache: 'no-store',
        });
        if (!res.ok) throw new Error('Fetch failed: ' + res.status);
        const data = await res.json();

        if (data.questions) {
          data.questions.forEach((q) => {
            if (q.Answer) {
              q.Answer = CryptoJS.MD5(String(q.Answer) + SALT).toString();
            }
          });
        }
        return data;
      }

      function optionKeys(q) {
        return Object.keys(q)
          .filter((k) => /^Option\d+$/i.test(k) && q[k])
          .sort((a, b) => parseInt(a.replace(/\D/g, '')) - parseInt(b.replace(/\D/g, '')));
      }

      /* ---------------- SELECTION ---------------- */
      function selectWithQuotas(pool, setting) {
        const quotas = {
          Hard: +setting.Hard || 0,
          Medium: +setting.Medium || 0,
          Easy: +setting.Easy || 0,
        };

        const totalTarget = quotas.Hard + quotas.Medium + quotas.Easy;

        let poolHard = shuffle(pool.filter((q) => (q.Difficulty || '').toLowerCase() === 'hard'));
        let poolMed = shuffle(pool.filter((q) => (q.Difficulty || '').toLowerCase() === 'medium'));
        let poolEasy = shuffle(pool.filter((q) => (q.Difficulty || '').toLowerCase() === 'easy'));

        let selected = [];

        let hardToPick = quotas.Hard;
        let fromHard = poolHard.splice(0, hardToPick);
        selected.push(...fromHard);

        let shortageHard = hardToPick - fromHard.length;
        if (shortageHard > 0) {
          let fromMedForHard = poolMed.splice(0, shortageHard);
          selected.push(...fromMedForHard);
          let stillShort = shortageHard - fromMedForHard.length;
          if (stillShort > 0) {
            selected.push(...poolEasy.splice(0, stillShort));
          }
        }

        let medToPick = quotas.Medium;
        let fromMed = poolMed.splice(0, medToPick);
        selected.push(...fromMed);

        let shortageMed = medToPick - fromMed.length;
        if (shortageMed > 0) {
          selected.push(...poolEasy.splice(0, shortageMed));
        }

        let easyToPick = quotas.Easy;
        selected.push(...poolEasy.splice(0, easyToPick));

        return shuffle(selected.slice(0, totalTarget));
      }

      /* ---------------- RENDERING ---------------- */
      function buildNav() {
        const nav = $('questionNav');
        nav.innerHTML = '';

        quizQuestions.forEach((q, i) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn nav-qbtn ' + (q.selected ? 'answered' : 'unanswered');
          btn.textContent = i + 1;
          btn.onclick = () => {
            currentIndex = i;
            renderQuestion();
          };
          nav.appendChild(btn);
        });
      }

      function updateNavStyles() {
        Array.from($('questionNav').children).forEach((btn, i) => {
          btn.classList.toggle('answered', !!quizQuestions[i].selected);
          btn.classList.toggle('unanswered', !quizQuestions[i].selected);
        });
      }

      function renderQuestion() {
        const q = quizQuestions[currentIndex],
          wrap = $('questionWrapper');

        if (!q) {
          wrap.innerHTML = '<div>Tidak ada soal</div>';
          return;
        }

        let html = `

    <div>
    <div class="mb-2"><strong>${currentIndex + 1}.</strong> ${q.Question || ''}</div>
    <hr/>
  `;

        const keys = optionKeys(q);

        if (!shuffledOptionsMap[currentIndex]) {
          shuffledOptionsMap[currentIndex] = shuffleArray([...keys]);
        }

        const randomizedKeys = shuffledOptionsMap[currentIndex];

        if (keys.length === 0) {
          html += `<div class="text-muted">Tidak ada jawaban.</div>`;
        } else {
          html += `<div>`;
          randomizedKeys.forEach((key) => {
            const originalIdx = key.replace(/\D/g, '');
            const checked = String(q.selected || '') === String(originalIdx) ? 'checked' : '';

            html += `
      <div class="form-check mb-2">
        <input class="form-check-input" type="radio" 
          name="answer" id="opt${originalIdx}" value="${originalIdx}" ${checked}>
        <label class="form-check-label" for="opt${originalIdx}">
          ${q[key]}
        </label>
      </div>`;
          });
          html += `</div>`;
        }

        wrap.innerHTML = html;
        if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();

        document.querySelectorAll('input[name="answer"]').forEach((inp) => {
          inp.addEventListener('change', (ev) => {
            q.selected = ev.target.value;
            updateNavStyles();
            saveProgres();
          });
        });
        updateNavStyles();
      }

      function updateTimer() {
        $('timerDisplay').textContent = fmtTime(timeLeft);
      }

      /* ---------------- EVENTS ---------------- */
      $('debugBtn').addEventListener('click', async () => {
        try {
          rawData = await fetchQuizData();
          $('loginMsg').textContent = 'Quiz siap dimulai.';
        } catch (e) {
          console.error(e);
          $('loginMsg').textContent = e.message;
        }
      });

      $('startBtn').addEventListener('click', async () => {
        const name = $('studentName').value.trim();
        const code = $('quizCodeInput').value.trim().toUpperCase();

        if (!name) {
          $('loginMsg').textContent = 'Masukkan nama.';
          return;
        }
        if (!code) {
          $('loginMsg').textContent = 'Masukkan kode quiz.';
          return;
        }

        $('loginMsg').textContent = 'Memulai quiz...';

        try {
          rawData = await fetchQuizData();
        } catch (e) {
          $('loginMsg').textContent = 'Tidak dapat memuat data quiz: ' + e.message;
          return;
        }

        quizSetting = (rawData.settings || []).find(
          (s) =>
            String(s.Code || '')
              .toUpperCase()
              .trim() === code
        );

        if (!quizSetting) {
          $('loginMsg').textContent = 'Kode Quiz tidak ditemukan.';
          return;
        }

        (startTime = new Date()), (start = quizSetting.StartDate ? new Date(quizSetting.StartDate) : null), (end = quizSetting.EndDate ? new Date(quizSetting.EndDate) : null);

        if (start && startTime < start) {
          $('loginMsg').textContent = 'Quiz belum dimulai.';
          return;
        }

        if (end && startTime > end) {
          $('loginMsg').textContent = 'Quiz telah selesai.';
          return;
        }

        const backup = loadProgres(code);

        if (backup && confirm('Ditemukan progres sebelumnya. Lanjutkan?')) {
          quizQuestions = backup.questions;
          quizEndTime = backup.endTime;
          currentIndex = backup.currentIndex;
          tabViolations = backup.violations;
        } else {
          const pool = (rawData.questions || []).filter(
            (q) =>
              String(q.QuizCode || '')
                .toUpperCase()
                .trim() === code &&
              String(q.Subject || '')
                .toUpperCase()
                .trim() ===
                String(quizSetting.Subject || '')
                  .toUpperCase()
                  .trim() &&
              String(q.Grade || '') === String(quizSetting.Grade || '')
          );

          if (pool.length === 0) {
            $('loginMsg').textContent = 'Soal belum tersedia di bank soal.';
            return;
          }

          quizQuestions = selectWithQuotas(pool, quizSetting);

          quizQuestions.forEach((q) => {
            const keys = optionKeys(q);
            const optionTexts = keys.map((k) => q[k]);
            q.shuffledOptions = shuffleArray([...optionTexts]);
          });

          if (quizQuestions.length === 0) {
            $('loginMsg').textContent = 'Jumlah soal tidak mencukupi kuota.';
            return;
          }

          setEndTime = Date.now() + quizSetting.TimeLimit * 60 * 1000;
          quizEndTime = setEndTime < end ? setEndTime : end;
          tabViolations = 0;
          currentIndex = 0;
        }

        const timeRemainingCheck = quizEndTime - Date.now();

        if (timeRemainingCheck <= 0) {
          alert('Maaf, waktu pengerjaan untuk sesi Anda telah berakhir.');
          submitQuiz(true);
          return;
        }

        // --- SETUP UI ---
        $('loginSection').style.display = 'none';
        $('quizSection').style.display = 'block';
        $('quizTitle').textContent = `${quizSetting.Title || 'Quiz'} - ${quizSetting.Subject}`;
        $('violationCount').innerText = tabViolations;

        buildNav();
        renderQuestion();

        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const diff = quizEndTime - Date.now();

          if (diff <= 0) {
            clearInterval(timerInterval);
            submitQuiz(true);
            return;
          }

          const s = Math.floor(diff / 1000);
          const m = Math.floor(s / 60);
          const sec = s % 60;
          $('timerDisplay').textContent = `${m}:${sec.toString().padStart(2, '0')}`;

          if (s % 5 === 0) saveProgres();
        }, 1000);
      });

      $('prevBtn').addEventListener('click', () => {
        if (currentIndex > 0) {
          currentIndex--;
          renderQuestion();
        }
      });

      $('nextBtn').addEventListener('click', () => {
        if (currentIndex < quizQuestions.length - 1) {
          currentIndex++;
          renderQuestion();
        }
      });

      $('submitBtn').addEventListener('click', (e) => {
        e.preventDefault();
        submitQuiz(false);
      });

      window.selectOption = (val) => {
        quizQuestions[currentIndex].selected = val;
        renderQuestion();
        buildNav();
        saveProgres();
      };

      /* ---------------- SUBMIT ---------------- */
      function submitQuiz(auto = false) {
        if (isSubmitting) return;

        if (!auto && !confirm('Kumpulkan Jawaban?')) return;

        isSubmitting = true;

        $('submitBtn').disabled = true;
        $('submitBtn').innerText = 'Mengirim...';

        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        submitTime = new Date();

        const answers = {};
        const correct = quizQuestions.reduce((acc, q) => {
          const key = q.QuestionID || 'Q_' + Math.random().toString(36).slice(2, 8);
          const studentChoice = q.selected ? String(q.selected) : '';
          answers[key] = studentChoice;

          const hashedStudentChoice = studentChoice ? CryptoJS.MD5(studentChoice + SALT).toString() : null;

          if (hashedStudentChoice && q.Answer && hashedStudentChoice === q.Answer) {
            return acc + 1;
          }
          return acc;
        }, 0);

        const score = quizQuestions.length ? Math.round((100 * correct) / quizQuestions.length) : 0;
        const pass = score >= (+quizSetting.MinScore || 0) ? 'LULUS' : 'BELUM LULUS';

        const payload = {
          studentName: $('studentName').value,
          quizCode: quizSetting.Code,
          subject: quizSetting.Subject,
          answers,
          score,
          pass,
          startTime,
          submitTime,
          tabViolations,
        };

        const student = $('studentName').value;
        sendResult(payload)
          .then(() => {
            localStorage.removeItem('ansor_pro_save');
            $('quizSection').style.display = 'none';
            $('resultSection').style.display = 'block';

            $('studentNameResult').innerText = payload.studentName;
            $('correctCount').innerText = correct;
            $('totalCount').innerText = quizQuestions.length;
            $('kodeQuiz').innerText = quizSetting.Code;

            const finalscore = $('finalScore');
            finalscore.innerText = score;
            finalscore.className = pass === 'LULUS' ? 'fs-4 text-success' : 'fs-4 text-danger';

            const correctcount = $('correctCount');
            correctcount.innerText = correct;
            correctcount.className = pass === 'LULUS' ? 'fs-4 text-success' : 'fs-4 text-danger';

            const badge = $('passBadge');
            badge.innerText = pass;
            badge.className = pass === 'LULUS' ? 'badge rounded-pill fs-6 px-4 py-2 mt-2 bg-success' : 'badge rounded-pill fs-6 px-4 py-2 mt-2 bg-danger';
          })
          .catch(() => {
            isSubmitting = false;
            $('submitBtn').disabled = false;
            $('submitBtn').innerText = 'Kirim Jawaban';
            alert('Submit failed — see console');
          });
      }

      function sendResult(payload) {
        return fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        })
          .then((res) => res.text())
          .then((txt) => {
            const data = JSON.parse(txt);
            if (data && data.status === 'success') {
              console.log('✅ Submit success:', data);
            } else {
              console.error('❌ Submit error:', data);
              throw new Error('Server error');
            }
          })
          .catch((err) => {
            console.error('⚠️ Network error:', err);
          });
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  </body>
</html>
